rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users: Authenticated users can read all profiles (for search)
    // Write: Own profile OR dummy users (for testing)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == userId || userId.matches('dummy_.*'));
      
      // Friends subcollection: Only the user can read/write their friend list
      // OR if it's a dummy user being managed
      match /friends/{friendId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendId || userId.matches('dummy_.*'));
      }
    }
    
    // Goals: Read authenticated (to see friends' goals)
    // Write: Own goals OR dummy goals
    match /goals/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == userId || userId.matches('dummy_.*'));
    }
    
    match /goals/{userId}/pastGoals/{goalId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || userId.matches('dummy_.*'));
    }
    
    // Friend Requests:
    // - Create: If you are the sender
    // - Read/Delete: If you are the sender or receiver
    match /friendRequests/{requestId} {
      allow create: if request.auth != null && request.resource.data.from == request.auth.uid;
      allow read, delete: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
      allow update: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
    }

    // Motivations:
    // - Create: If you are the sender OR if sender is a dummy user (for testing)
    // - Read: If you are the sender or receiver
    match /motivations/{motivationId} {
      allow create: if request.auth != null && (request.resource.data.from == request.auth.uid || request.resource.data.from.matches('dummy_.*'));
      // Allow update if sender (edit message) OR receiver (save/unsave)
      allow update: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
      allow read: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
      // Allow delete if receiver (cleanup on goal completion)
      allow delete: if request.auth != null && resource.data.to == request.auth.uid;
    }

    // Missions:
    // - Create: Motivator creates mission for challenger
    // - Read: Both sender (motivator) and receiver (challenger) can read
    // - Update: Challenger can accept/reject/submit proof, Motivator can verify
    // - Delete: Either party can delete (e.g., on reject or unfriend)
    match /missions/{missionId} {
      allow create: if request.auth != null && request.resource.data.from == request.auth.uid;
      allow read: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
      allow update: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
      allow delete: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
    }

    // Notifications:
    // - Create: Authenticated users can create notifications
    // - Read/Update: Users can read/update their own notifications
    match /notifications/{notificationId} {
      allow create: if request.auth != null && request.resource.data.from == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.to == request.auth.uid;
    }
  }
}
